(()=>{"use strict";const e={advanced_filter:[""],allow_list:[""],background_color:"rgb(0, 0, 0)",decompress_on_hover:!1,exclude_url:["https://twitter.com/home"],font_color:"rgb(255, 255, 255)",hide_completely:!1,include_user_name:!1,include_verified_account:!1,main_color:"rgb(29, 161, 242)",ng_word:[""],show_reason:!0};class t{constructor(){this.setting=e,this.callback=null}async load(){const t=await browser.storage.local.get("setting"),r=e;return t.setting&&Object.keys(t.setting).filter((t=>t in e)).forEach((e=>r[e]=t.setting[e])),browser.storage.onChanged.addListener((e=>{this.setting=e.setting.newValue,this.callback&&this.callback()})),new Proxy(r,{get:(e,t)=>this.setting[t],set:(e,t,r)=>(this.setting[t]=r,this.save(),!0)})}save(){browser.storage.local.set({setting:this.setting})}onChange(e){this.callback=e}}class r{constructor(){this.emoji_list=null}async init(){const e=await fetch(browser.runtime.getURL("dist/twitter-emoji-url-list/twitter-emoji-url-list.json"));this.emoji_list=await e.json()}get_from_url(e){if(!this.emoji_list)throw new Error("Emoji.init() must be called before Emoji.using get_from_url().");return e in this.emoji_list?this.emoji_list[e]:null}}const o=(e,t)=>t.some((t=>t instanceof RegExp?t.test(e):t===e));const s=["#","＃"],n=e=>e.normalize("NFKC").toLowerCase().replace(/[ぁ-ん]/gu,(e=>String.fromCharCode(e.charCodeAt(0)+96))),a=e=>function(e,t){if(t={defaultProtocol:"http:",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,sortQueryParameters:!0,...t},e=e.trim(),/^data:/i.test(e))return((e,{stripHash:t})=>{const r=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(e);if(!r)throw new Error(`Invalid URL: ${e}`);let{type:o,data:s,hash:n}=r.groups;const a=o.split(";");n=t?"":n;let i=!1;"base64"===a[a.length-1]&&(a.pop(),i=!0);const c=(a.shift()||"").toLowerCase(),l=[...a.map((e=>{let[t,r=""]=e.split("=").map((e=>e.trim()));return"charset"===t&&(r=r.toLowerCase(),"us-ascii"===r)?"":`${t}${r?`=${r}`:""}`})).filter(Boolean)];return i&&l.push("base64"),(l.length>0||c&&"text/plain"!==c)&&l.unshift(c),`data:${l.join(";")},${i?s.trim():s}${n?`#${n}`:""}`})(e,t);if(/^view-source:/i.test(e))throw new Error("`view-source:` is not supported as it is a non-standard protocol");const r=e.startsWith("//");!r&&/^\.*\//.test(e)||(e=e.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const s=new URL(e);if(t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&"https:"===s.protocol&&(s.protocol="http:"),t.forceHttps&&"http:"===s.protocol&&(s.protocol="https:"),t.stripAuthentication&&(s.username="",s.password=""),t.stripHash?s.hash="":t.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const e=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let t=0,r="";for(;;){const o=e.exec(s.pathname);if(!o)break;const n=o[0],a=o.index;r+=s.pathname.slice(t,a).replace(/\/{2,}/g,"/"),r+=n,t=a+n.length}r+=s.pathname.slice(t,s.pathname.length).replace(/\/{2,}/g,"/"),s.pathname=r}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(!0===t.removeDirectoryIndex&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let e=s.pathname.split("/");const r=e[e.length-1];o(r,t.removeDirectoryIndex)&&(e=e.slice(0,-1),s.pathname=e.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const e of[...s.searchParams.keys()])o(e,t.removeQueryParameters)&&s.searchParams.delete(e);!0===t.removeQueryParameters&&(s.search=""),t.sortQueryParameters&&s.searchParams.sort(),t.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,""));const n=e;return e=s.toString(),t.removeSingleSlash||"/"!==s.pathname||n.endsWith("/")||""!==s.hash||(e=e.replace(/\/$/,"")),(t.removeTrailingSlash||"/"===s.pathname)&&""===s.hash&&t.removeSingleSlash&&(e=e.replace(/\/$/,"")),r&&!t.normalizeProtocol&&(e=e.replace(/^http:\/\//,"//")),t.stripProtocol&&(e=e.replace(/^(?:https?:)?\/\//,"")),e}(e,{removeDirectoryIndex:!0,removeQueryParameters:!0,stripHash:!0,stripProtocol:!0}),i=e=>n(e.replace(new RegExp(`^[${s.join()}]`,"u"),"")),c=e=>n(e.replace(/^[@＠]/u,"")),l={checked_tweet_class_name:"spam-tweets-compressor-checked",hashtag_link_mention:".css-4rbku5.css-18t94o4.css-901oao.css-16my406.r-1loqt21.r-poiln3.r-bcqeeo.r-qvutc0",link_scheme_outer:".css-901oao.css-16my406.r-1tl8opc.r-hiw28u.r-qvk6io.r-bcqeeo.r-qvutc0",media:Object.values({image:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1s2bzr4.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg",summary_card:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-18u37iz.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg",summary_with_large_image:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg",video:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1s2bzr4.r-1ny4l3l.r-1udh08x"}).join(","),normal_text:".css-901oao.css-16my406.r-1tl8opc.r-bcqeeo.r-qvutc0",show_tweet_button:".show-tweet-button",timeline:"main",tweet_button_inner:".css-4rbku5.css-18t94o4.css-1dbjc4n.r-42olwf.r-sdzlij.r-1phboty.r-rs99b7.r-1waj6vr.r-1loqt21.r-19yznuf.r-64el8z.r-1ny4l3l.r-o7ynqc.r-6416eg.r-lrvibr",tweet_content:".css-901oao.r-a023e6.r-16dba41.r-rjixqe.r-bcqeeo.r-bnwqim.r-qvutc0",tweet_outer:"div.css-1dbjc4n.r-1adg3ll.r-1ny4l3l",user_id:".css-901oao.css-bfa6kz.r-18u37iz.r-16dba41.r-bcqeeo.r-qvutc0",user_name:".css-901oao.css-bfa6kz.r-1awozwy.r-6koalj.r-1tl8opc.r-a023e6.r-b88u0q.r-rjixqe.r-bcqeeo.r-1udh08x.r-3s2u2q.r-qvutc0",verified_badge:"svg.r-4qtqp9.r-yyyyoo.r-1xvli5t.r-9cviqr.r-f9ja8p.r-og9te1.r-bnwqim.r-1plcrui.r-lrvibr"};class u{constructor(e,t){this.tweet=e,this.content_element=e.querySelector(l.tweet_content),this.emoji_detector=t,this.decompress_button=document.createElement("button")}get_text_content(e){const t=e.cloneNode(!0),r=document.createElement("div");return r.appendChild(t),r.querySelectorAll("img").forEach((e=>{const t=this.emoji_detector.get_from_url(e.src);t&&e.insertAdjacentText("afterend",t),e.remove()})),r.textContent}get content(){return this.content_element?this.get_text_content(this.content_element)||"":null}get user_name(){const e=this.tweet.querySelector(l.user_name);return e&&this.get_text_content(e)||""}get user_id(){const e=this.tweet.querySelector(l.user_id);return e?c(e.textContent||""):null}get language(){return this.get_language()}async get_language(){const e=this.content_element;let t=this.content||"";if(e){const r=e.cloneNode(!0),o=document.createElement("div");o.appendChild(r),o.querySelectorAll(l.hashtag_link_mention).forEach((e=>e.remove())),t=o.textContent||""}const r=await browser.i18n.detectLanguage(t);return r.isReliable?r.languages[0].language.replace(/-.*$/u,""):this.content_element&&this.content_element.lang?this.content_element.lang:""}compress(e,t){this.decompress_button.setAttribute("class",this.tweet.getAttribute("class")||""),this.decompress_button.classList.add(l.show_tweet_button.replace(/^\./u,""));const{user_name:r}=this.tweet,{user_id:o}=this.tweet;if(e){const t=browser.i18n.getMessage("decompress_button_strict_with_reason",[r,`@${o}`,e]);this.decompress_button.textContent=t}else{const e=browser.i18n.getMessage("decompress_button_strict_without_reason",[r,`@${o}`]);this.decompress_button.textContent=e}this.decompress_button.addEventListener("click",(()=>{this.tweet.style.display="block",this.decompress_button.remove()})),t&&this.decompress_button.addEventListener("mouseover",(()=>{this.tweet.style.display="block",this.decompress_button.remove()})),this.tweet.style.display="none",this.tweet.insertAdjacentElement("afterend",this.decompress_button)}hide_completely(){this.tweet.style.display="none",this.decompress_button.style.display="none"}get hashtag(){return[...this.tweet.querySelectorAll(l.hashtag_link_mention)].filter((e=>e.textContent&&s.includes(e.textContent[0]))).map((e=>i(e.textContent||"")))}get link(){return[...this.tweet.querySelectorAll(l.hashtag_link_mention)].filter((e=>Boolean(e.querySelector(l.link_scheme_outer)))).map((e=>a((e.textContent||"").replace(/…$/u,""))))}}const h=async(e=!0)=>{let r;const o=await(new t).load(),s=document.querySelector(l.tweet_button_inner),n=getComputedStyle(document.body).backgroundColor,a=document.querySelector(l.normal_text);if(s&&n&&a)o.main_color=getComputedStyle(s).backgroundColor,o.background_color=n,o.font_color=getComputedStyle(a).color;else{if(!e)throw new Error("Failed to get color setting.");r=new Promise(((e,t)=>{setInterval((()=>{h(!1).then((()=>e())).catch((e=>t(e)))}),1e3)}))}return r},d=(e,t)=>e.replace(/^rgb\(/u,"rgba(").replace(/\)$/u,`, ${t})`),m=async()=>{const e=await(new t).load(),r=document.createElement("style");r.textContent=`\n:root {\n    --main_color: ${e.main_color};\n    --background_color: ${e.background_color};\n    --high_emphasize_text_color: ${d(e.font_color,1)};\n    --medium_emphasize_text_color: ${d(e.font_color,.87)};\n}\n    `,document.body.appendChild(r)},_=["d","g","i","m","s","u","y"],p=new RegExp(`^/(.*)/([${_.join("")}]*)$`,"u"),g=e=>p.test(e),w=e=>{const t=(e=>{if(!g(e))return{flag:null,string:e};const t=e.replace(p,"$1"),r=new Set(e.replace(p,"$2").split("")),o=Array.from(r).filter((e=>_.includes(e)));return{flag:o.length?o.join(""):null,string:t}})(e);return t.flag?new RegExp(t.string,`${t.flag}u`):new RegExp(t.string,"u")},b=(e,t)=>{const r=g(t);if("string"==typeof e)return r?w(t).test(e):e.includes(t);{let o=!1;return e.forEach((e=>{(r&&w(t).test(e)||e===t)&&(o=!0)})),o}},y=(e,t)=>{let r="and"===e[0];return e[1].forEach((o=>{let s=!1;if(null!==(n=o)&&"object"==typeof n&&"mode"in n&&"type"in n&&"string"in n&&"string"==typeof n.mode&&"string"==typeof n.type&&"string"==typeof n.string){let e=!1;switch(o.type){case"text":e=b(t.content,o.string);break;case"hashtag":e=b(t.hashtag,i(o.string));break;case"id":e=b(t.user_id,c(o.string));break;case"name":e=b(t.user_name,o.string);break;case"link":e=b(t.link,g(o.string)?o.string:a(o.string));break;default:e=!1}s="include"===o.mode?e:!e}else s=y(o,t);var n;"and"!==e[0]||s?"or"===e[0]&&s&&(r=!0):r=!1})),r},f=(e,t)=>{for(const r of t)if(r){if(g(r)&&w(r).test(e))return!0;if(e.includes(r))return!0}return!1},v=(e,t,r)=>{const o=(()=>{const o=n(e.content);return f(o,t.ng_word)||t.include_user_name&&f(n(e.user_name),t.ng_word)?browser.i18n.getMessage("compress_reason_ng_word"):!!y(r,e)&&browser.i18n.getMessage("compress_reason_advanced_detection_default")})(),s=Boolean(e.querySelector(l.verified_badge))&&!t.include_verified_account;return!1===o||s?[!1]:[!0,o]},x=new class{constructor(){this.emoji_detector=new r,this.initialized=!1}async init(){await this.emoji_detector.init(),this.initialized=!0}generate(e){e.classList.add(l.checked_tweet_class_name);const t=new u(e,this.emoji_detector),r="stc_show_user_id_error=true";return["/notifications"].includes(location.pathname)||null===t.content||null!==t.user_id||document.cookie.includes(r)||(alert(browser.i18n.getMessage("error_message_user_id_bug")),document.cookie="stc_show_user_id_error=true;max-age=86400"),e.content=t.content||"",e.user_name=t.user_name,e.user_id=t.user_id||"",e.language=t.language,e.compress=(e,r,o)=>{e?t.hide_completely():t.compress(r,o)},e.hashtag=t.hashtag,e.link=t.link,e}},k=async e=>{const t=await fetch(e);return await t.json()},q=async e=>{const t=[],r=await k("https://cdn.statically.io/gh/Robot-Inventor/stc-filter/main/dist/advanced_filter.json"),o=Object.keys(r).filter((t=>e.includes(r[t].id))).map((e=>r[e].url)),s=async e=>(await k(e)).rule;for(const e of o)t.push(s(e));return["or",[...await Promise.all(t)]]};x.init().then((async()=>{const e=new t,r=await e.load();let o=await q(r.advanced_filter);const s=async()=>{o=await q(r.advanced_filter)};setInterval((()=>{s()}),864e5),e.onChange((()=>{(async()=>{await s(),document.querySelectorAll(l.show_tweet_button).forEach((e=>e.click())),document.querySelectorAll(`.${l.checked_tweet_class_name}`).forEach((e=>e.classList.remove(l.checked_tweet_class_name)))})()}));const n=document.body,a=new MutationObserver((()=>{const e=document.querySelector(l.timeline);if(e){a.disconnect(),h().then(m).catch((e=>console.error(e)));const t=e;new MutationObserver((()=>{((e,t)=>{const{exclude_url:r}=e;if(r.includes(location.href))return;const o=[...document.querySelectorAll(`${l.tweet_outer}:not(.${l.checked_tweet_class_name})`)].map((e=>x.generate(e)));for(const r of o){if(e.allow_list.map(c).includes(r.user_id))continue;const o=v(r,e,t);o[0]&&(e.show_reason?r.compress(e.hide_completely,o[1],e.decompress_on_hover):r.compress(e.hide_completely,void 0,e.decompress_on_hover))}})(r,o)})).observe(t,{childList:!0,subtree:!0})}}));a.observe(n,{childList:!0,subtree:!0})})).catch((e=>console.error(e)))})();